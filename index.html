<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treat Clicker</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f3f1; }
        #cat-image {
            cursor: pointer;
            transition: transform 0.1s ease-out;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border: 8px solid #ff7f50; /* Coral border */
        }
        #cat-image:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        .upgrade-card {
            transition: background-color 0.15s;
        }
        .upgrade-card:hover {
            background-color: #ffe6dd; /* Light coral hover */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Firebase Message Box (Hidden by Default) -->
    <div id="message-box" class="message-box hidden bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center border-t-4 border-red-500">
        <p class="text-lg font-bold text-red-700 mb-4">Error</p>
        <p id="message-text" class="text-gray-700 mb-6">There was an issue loading the game data.</p>
        <button onclick="document.getElementById('message-box').classList.add('hidden')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
            Close
        </button>
    </div>

    <!-- Main Game Container -->
    <div class="w-full max-w-6xl flex flex-col lg:flex-row bg-white rounded-2xl shadow-xl p-6 lg:p-10">

        <!-- Left Column: Stats and Cat Image -->
        <div class="flex-1 lg:pr-8 mb-8 lg:mb-0">
            <h1 class="text-4xl font-extrabold text-orange-600 mb-2 text-center lg:text-left">Treat Clicker</h1>
            <p class="text-gray-500 text-center lg:text-left mb-6">Make this kitty rich!</p>

            <!-- Stats -->
            <div class="bg-yellow-50 border-4 border-yellow-300 rounded-xl p-4 mb-8 shadow-inner">
                <div class="text-2xl font-bold text-gray-700 mb-1 flex justify-between">
                    <span>Treats:</span>
                    <span id="treat-count" class="text-orange-700">0</span>
                </div>
                <div class="text-lg text-gray-600 flex justify-between">
                    <span>Treats per Second (CPS):</span>
                    <span id="cps-count" class="text-green-600">0</span>
                </div>
                <div class="text-lg text-gray-600 flex justify-between">
                    <span>Treats per Click:</span>
                    <span id="cpc-count" class="text-blue-600">1</span>
                </div>
                <p id="user-id-display" class="text-sm text-gray-400 mt-2 text-center break-all">User ID: Loading...</p>
            </div>

            <!-- Cat Image Clicker Area -->
            <div class="flex justify-center items-center">
                <img id="cat-image" src="Screenshot 2025-11-09 170341.png" alt="Adorable cat standing, ready to be clicked." class="w-full max-w-xs h-auto rounded-full ring-4 ring-offset-4 ring-orange-400">
            </div>

        </div>

        <!-- Right Column: Upgrades -->
        <div class="flex-1">
            <h2 class="text-3xl font-bold text-gray-700 mb-6 text-center lg:text-left">Upgrades</h2>
            <div id="upgrades-container" class="space-y-4">
                <!-- Upgrade Cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Firebase and Game Logic -->
    <script type="module">
        // --- Firebase Imports (Fixed to use standard CDN imports) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Set log level to debug for better console feedback
        setLogLevel('debug');

        // --- Global Variables (Canvas Context) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-treat-clicker-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = 'loading';
        let isAuthReady = false;

        // --- Game State ---
        let treats = 0;
        let cpc = 1; // Clicks per treat
        let cps = 0; // Treats per second
        let gameInitialized = false;

        const UPGRADE_DATA = [
            { id: 'click-power', name: 'Paws of Fury (Click)', baseCost: 10, multiplier: 1.15, baseCpcIncrease: 1, level: 0, type: 'cpc' },
            { id: 'auto-purrer', name: 'Automatic Purrer', baseCost: 50, multiplier: 1.20, baseCpsIncrease: 1, level: 0, type: 'cps' },
            { id: 'catnip-farm', name: 'Catnip Farm', baseCost: 500, multiplier: 1.25, baseCpsIncrease: 10, level: 0, type: 'cps' },
            { id: 'laser-pointer', name: 'Laser Pointer Brigade', baseCost: 5000, multiplier: 1.30, baseCpsIncrease: 100, level: 0, type: 'cps' }
        ];

        // --- DOM Elements ---
        const treatCountEl = document.getElementById('treat-count');
        const cpsCountEl = document.getElementById('cps-count');
        const cpcCountEl = document.getElementById('cpc-count');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const catImageEl = document.getElementById('cat-image');
        const upgradesContainerEl = document.getElementById('upgrades-container');

        // --- Utility Functions ---
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num);
        }

        function calculateCost(upgrade) {
            return Math.floor(upgrade.baseCost * Math.pow(upgrade.multiplier, upgrade.level));
        }

        function showMessage(title, text) {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').innerText = text;
            box.querySelector('p:first-child').innerText = title;
            box.classList.remove('hidden');
        }

        // --- Game Logic ---

        function updateDisplay() {
            treatCountEl.textContent = formatNumber(treats);
            cpsCountEl.textContent = formatNumber(cps);
            cpcCountEl.textContent = formatNumber(cpc);
            userIdDisplayEl.textContent = `User ID: ${userId}`;
        }

        function calculateCpc() {
            const clickUpgrade = UPGRADE_DATA.find(u => u.id === 'click-power');
            cpc = 1 + (clickUpgrade.level * clickUpgrade.baseCpcIncrease);
        }

        function calculateCps() {
            cps = UPGRADE_DATA
                .filter(u => u.type === 'cps')
                .reduce((total, upgrade) => total + (upgrade.level * upgrade.baseCpsIncrease), 0);
        }

        function renderUpgrades() {
            upgradesContainerEl.innerHTML = ''; // Clear existing
            UPGRADE_DATA.forEach(upgrade => {
                const cost = calculateCost(upgrade);
                const canAfford = treats >= cost;

                const card = document.createElement('div');
                card.id = `upgrade-${upgrade.id}`;
                card.className = `upgrade-card p-4 rounded-xl shadow-md flex justify-between items-center transition-all duration-300 ${canAfford ? 'bg-orange-100 hover:bg-orange-200 cursor-pointer' : 'bg-gray-100 cursor-not-allowed opacity-70'}`;
                card.onclick = () => buyUpgrade(upgrade.id);

                const info = `
                    <div class="flex-1 mr-4">
                        <h3 class="text-xl font-semibold text-gray-800">${upgrade.name}</h3>
                        <p class="text-sm text-gray-600">${upgrade.type === 'cpc' ? `+${formatNumber(upgrade.baseCpcIncrease)} Treats per Click` : `+${formatNumber(upgrade.baseCpsIncrease)} CPS`}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold ${canAfford ? 'text-green-600' : 'text-red-500'}">${formatNumber(cost)} Treats</p>
                        <p class="text-sm font-medium text-blue-600">Level: ${upgrade.level}</p>
                    </div>
                `;
                card.innerHTML = info;
                upgradesContainerEl.appendChild(card);
            });
        }

        function gameLoop() {
            if (gameInitialized) {
                // Add treats based on CPS every second
                treats += cps;
                updateDisplay();
                // We don't save every second, only when a major change happens (like buying)
            }
            // Runs every 1000 milliseconds (1 second)
            setTimeout(gameLoop, 1000); 
        }

        // --- User Actions ---

        function clickCat() {
            if (!gameInitialized) return;
            
            treats += cpc;
            updateDisplay();
            // Minor visual effect on click (already handled by CSS :active)
            saveGame(); // Save on click for persistence, though this might be heavy.
        }

        function buyUpgrade(id) {
            if (!gameInitialized) return;

            const upgrade = UPGRADE_DATA.find(u => u.id === id);
            const cost = calculateCost(upgrade);

            if (treats >= cost) {
                treats -= cost;
                upgrade.level += 1;

                // Recalculate stats
                calculateCpc();
                calculateCps();
                
                // Update display and save
                updateDisplay();
                renderUpgrades();
                saveGame();

            } else {
                showMessage('Cannot Afford', `You need ${formatNumber(cost)} treats to buy ${upgrade.name}, but you only have ${formatNumber(treats)}.`);
            }
        }

        // --- Firebase Integration ---
        
        function getGameDocRef(uid) {
            // Private data storage path: /artifacts/{appId}/users/{userId}/game_data/main_game_state
            return doc(db, 'artifacts', appId, 'users', uid, 'game_data', 'main_game_state');
        }

        async function saveGame() {
            if (!isAuthReady || !db) return;
            
            const gameState = {
                treats: treats,
                cpc: cpc, // Calculated value, but good to save for debugging
                cps: cps, // Calculated value, but good to save for debugging
                upgrades: UPGRADE_DATA.map(u => ({ id: u.id, level: u.level })),
                lastSave: Date.now()
            };

            try {
                // Use setDoc to save the state at the specific document reference
                await setDoc(getGameDocRef(userId), gameState);
                // console.log("Game saved successfully.");
            } catch (error) {
                console.error("Error saving game:", error);
                // showMessage('Save Error', 'Could not save game data. Check your network connection.');
            }
        }

        function setupFirestoreListener() {
            if (!isAuthReady || !db) return;

            const docRef = getGameDocRef(userId);

            // Set up a real-time listener
            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    treats = data.treats || 0;
                    
                    // Load upgrade levels
                    if (data.upgrades && Array.isArray(data.upgrades)) {
                        data.upgrades.forEach(savedUpgrade => {
                            const localUpgrade = UPGRADE_DATA.find(u => u.id === savedUpgrade.id);
                            if (localUpgrade) {
                                localUpgrade.level = savedUpgrade.level;
                            }
                        });
                    }

                    // Recalculate stats based on loaded levels
                    calculateCpc();
                    calculateCps();
                    
                    // Check for offline treats (simple logic)
                    const lastSaveTime = data.lastSave || Date.now();
                    const timeElapsedSeconds = Math.floor((Date.now() - lastSaveTime) / 1000);
                    
                    if (timeElapsedSeconds > 5 && data.cps > 0) {
                        const offlineGain = timeElapsedSeconds * data.cps;
                        treats += offlineGain;
                        showMessage('Welcome Back!', `You earned ${formatNumber(offlineGain)} treats while you were away!`);
                        // Immediately save the updated treats
                        saveGame(); 
                    }
                    
                    gameInitialized = true;
                    updateDisplay();
                    renderUpgrades();

                } else if (!gameInitialized) {
                    // Document doesn't exist, create initial game state
                    gameInitialized = true;
                    updateDisplay();
                    renderUpgrades();
                    saveGame();
                }
            }, (error) => {
                console.error("Firestore listen error:", error);
                showMessage('Connection Error', 'Could not connect to game data server. Please check your connection.');
            });
        }
        
        // --- Initialization ---

        async function initFirebase() {
            if (!firebaseConfig) {
                showMessage('Fatal Error', 'Firebase configuration is missing. Cannot initialize game.');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check for existing token or sign in anonymously
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // If no user, sign in anonymously or with custom token
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                const anonymousUser = await signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                            }
                        }
                        isAuthReady = true;
                        unsubscribe(); // Stop listening after successful auth
                        resolve();
                    });
                });
                
                setupFirestoreListener(); // Start listening for data now that auth is ready

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('Firebase Error', `Could not connect to the database. Error: ${error.message}`);
            }
        }
        
        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners
            catImageEl.addEventListener('click', clickCat);
            
            // Start Firebase and game logic
            initFirebase();
            
            // Start the main game loop (treats per second calculation)
            gameLoop();
        });
        
    </script>
</body>
</html>
